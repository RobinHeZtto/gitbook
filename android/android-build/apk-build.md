# APK编译过程

## APK编译过程

![](<../../.gitbook/assets/image (377).png>)

典型 Android 应用模块的构建流程按照以下常规步骤执行：

1. 编译器将您的源代码转换成 DEX 文件（Dalvik 可执行文件，其中包括在 Android 设备上运行的字节码），并将其他所有内容转换成编译后的资源。
2. APK 打包器将 DEX 文件和编译后的资源组合成单个 APK。不过，必须先为 APK 签名，然后才能将应用安装并部署到 Android 设备上。
3. APK 打包器使用调试或发布密钥库为 APK 签名：
   1. 如果您构建的是调试版应用（即专用于测试和分析的应用），则打包器会使用调试密钥库为应用签名。Android Studio 会自动使用调试密钥库配置新项目。
   2. 如果您构建的是打算对外发布的发布版应用，则打包器会使用发布密钥库为应用签名。如需创建发布密钥库，请参阅[在 Android Studio 中为应用签名](https://developer.android.com/studio/publish/app-signing?hl=zh-cn#studio)。
4. 在生成最终 APK 之前，打包器会使用 [zipalign](https://developer.android.com/studio/command-line/zipalign?hl=zh-cn) 工具对应用进行优化，以减少其在设备上运行时所占用的内存。

> 下图是网络上更加详细的图, 细节部分可能会有不一致的地方

![](<../../.gitbook/assets/image (49).png>)

Android APK的编译流程大致可以划分为2个部分: 1.是资源的编译; 2.是代码的编译

### 资源编译

apk资源包含:

* 工程中res目录下的所有文件
* assets目录下的文件
* AndroidManifest.xml

AAPT2（Android 资源打包工具）是一种构建工具，Android Studio 和 Android Gradle 插件使用它来编译和打包应用的[资源](https://developer.android.com/guide/topics/resources/providing-resources?hl=zh-cn)。AAPT2 会解析资源、为资源编制索引，并将资源编译为针对 Android 平台进行过优化的二进制格式。

#### aapt2产物:

* resources.arsc - 资源索引表
* res文件夹 - 包含图片, 布局文件等
* assets文件夹
* 二进制AndroidManifests.xml文件
* R文件

#### R文件:

&#x20;在aapt的编译过程中，除了assets资源外，其他的资源(string、color、layout等)都会被赋予一个资源ID, 资源的ID常量值保存在R类文件中供在开发阶段使用。

```
/* AUTO-GENERATED FILE. DO NOT MODIFY.
 *
 * This class was automatically generated by the
 * aapt tool from the resource data it found. It
 * should not be modified by hand.
 */

package com.test;

public final class R {
  public static final class color {
    public static final int colorAccent=0x7f010000;
    public static final int colorPrimary=0x7f010001;
    public static final int colorPrimaryDark=0x7f010002;
  }
  public static final class drawable {
    public static final int ic_launcher_background=0x7f020001;
    public static final int ic_launcher_foreground=0x7f020002;
  }
  public static final class layout {
    public static final int activity_main=0x7f030000;
  }
  public static final class mipmap {
    public static final int ic_launcher=0x7f040000;
    public static final int ic_launcher_round=0x7f040001;
  }
  public static final class string {
    public static final int app_name=0x7f050000;
  }
  public static final class style {
    /**
     * Base application theme.
     */
    public static final int AppTheme=0x7f060000;
  }
}

```

资源Id为16进制8位 int值，组成为**ppttdddd**，前2位表示packageId，第3-4位表示资源类别(resouceTypeId)，后4位标识该资源类别下的资源ID(resouceId)。

其中系统的packageID为\[01-7f)之间，应用程序的packageId默认为7f。 typeId 没有明细的映射关系，Id的值的分配为aapt2在处理过程中 根据资源类别被处理的先后从1开始递增1分配。resouceId同理，不过是从0开始递增的

> [aapt2中资源ID分配的源码](https://github.com/aosp-mirror/platform_frameworks_base/blob/master/tools/aapt2/compile/IdAssigner.cpp)

#### resources.arsc文件详解

在开发阶段，我们可以通过aapt生成的R类中的id 引用具体的资源，而 resources.arsc文件是一个资源索引表，供在程序运行时根据id索引到具体的资源。这里我们不分析运行时索引资源的过程，只分析resources.arsc中的内容结构。

![](<../../.gitbook/assets/image (384).png>)

### 代码编译

代码编译部分包含\
1.java源码文件\
2.已编译好的java 类库及jar包\
3.已编译好的带android资源的类库 即 aar包\
4.R类

> R类是由资源资源编译时aapt生成的

其中java源文件需要先通过 javac工具编译成 class文件,\
然后class文件和所有的jar包、包括aar包中的class文件 通过dx和d8编译器被编译成dex文件

## 参考

* [d8](https://developer.android.com/studio/command-line/d8?hl=zh-cn)
* [Android App包瘦身优化实践](https://tech.meituan.com/2017/04/07/android-shrink-overall-solution.html)
*
